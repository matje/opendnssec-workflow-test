# $Id: Makefile.am 3734 2010-08-11 11:18:06Z jakob $

MAINTAINERCLEANFILES = $(srcdir)/Makefile.in
CLEANFILES = token.db othertoken.db

LIBMM = ${top_builddir}/mm/src/libmm.a

AM_CPPFLAGS = \
		-I$(top_builddir)/common \
		-I$(srcdir)/../../mm/src \
		-I$(builddir)/../../mm/src \
		-I$(srcdir)/../src \
		@LDNS_INCLUDES@

AM_CFLAGS =	-std=c99

EXTRA_DIST =	*.xml $(srcdir)/softhsm.conf

noinst_PROGRAMS = hsmcheck
 
hsmcheck_LDADD = $(LIBMM) ../src/libhsm.a @LDNS_LIBS@ @XML2_LIBS@
hsmcheck_LDFLAGS = -no-install

SOFTHSM_ENV = SOFTHSM_CONF=$(srcdir)/softhsm.conf


token.db othertoken.db:
	env $(SOFTHSM_ENV) \
	softhsm --slot 0 --init-token --label softHSM \
		--so-pin 12345678 --pin 123456
	env $(SOFTHSM_ENV) \
	softhsm --slot 1 --init-token --label xyzzy \
		--so-pin 12345678 --pin 123456

check: regress-softhsm

regress:
	@echo use target 'regress-{aepkeyper,sca6000,softhsm,etoken,opensc,ncipher,multi}'

regress-aepkeyper: hsmcheck
	./hsmcheck -c conf-aepkeyper.xml -gsdr

regress-sca6000: hsmcheck
	./hsmcheck -c conf-sca6000.xml -gsdr

regress-softhsm: hsmcheck token.db
	env $(SOFTHSM_ENV) \
	./hsmcheck -c conf-softhsm.xml -gsdr

regress-etoken: hsmcheck
	./hsmcheck -c conf-etoken.xml -gsdr

regress-opensc: hsmcheck
	./hsmcheck -c conf-opensc.xml -gsdr

regress-ncipher: hsmcheck
	./hsmcheck -c conf-ncipher.xml -gsdr

regress-multi: hsmcheck token.db othertoken.db
	env $(SOFTHSM_ENV) \
	./hsmcheck -c conf-multi.xml -gsdr

